apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-moodle-config
  labels:
    app: moodle
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
data:
  config.php: |
    <?php  // Moodle configuration file

    unset($CFG);
    global $CFG;
    $CFG = new stdClass();

    // -------------------------------------------------------------------------
    // 1. Database Configuration
    // -------------------------------------------------------------------------
    $CFG->dbtype    = 'pgsql';
    $CFG->dblibrary = 'native';
    $CFG->dbhost    = getenv('MOODLE_DB_HOST');
    $CFG->dbname    = getenv('MOODLE_DB_NAME');
    $CFG->dbuser    = getenv('MOODLE_DB_USER');
    $CFG->dbpass    = getenv('MOODLE_DB_PASSWORD');
    $CFG->prefix    = 'mdl_';
    $CFG->dboptions = array (
      'dbpersist' => 0,
      'dbport'    => getenv('MOODLE_DB_PORT') ?: 5432,
      'dbsocket'  => '',
    );

    // -------------------------------------------------------------------------
    // 2. Site Configuration
    // -------------------------------------------------------------------------
    $CFG->wwwroot   = 'https://{{ .Values.ingress.hostname }}';
    $CFG->dataroot  = '/var/www/moodledata';
    $CFG->admin     = 'admin';

    // Non-root permission fix (UID 1001)
    $CFG->directorypermissions = 0770;

    // -------------------------------------------------------------------------
    // 3. Security & Hardening (Production Best Practices)
    // -------------------------------------------------------------------------
    // Prevent installing plugins via the UI (Security risk in containerized envs)
    // You should bake plugins into the Docker image instead.
    $CFG->disableupdateautodeploy = true;

    // Prevent password hashes from leaking in backups
    $CFG->includeuserpasswordsinbackup = false;

    // -------------------------------------------------------------------------
    // 4. Reverse Proxy & SSL (Crucial for Keycloak/OIDC)
    // -------------------------------------------------------------------------
    // K8s Ingress terminates SSL. We must trust the headers.
    if (getenv('MOODLE_SSL_PROXY') === 'true') {
        $CFG->sslproxy = true;
    }

    // If using Keycloak, simple sslproxy often isn't enough for redirect loops.
    // This setting ensures Moodle respects the X-Forwarded-Host headers fully.
    if (getenv('MOODLE_REVERSE_PROXY') === 'true') {
        $CFG->reverseproxy = true;
    }

    // =============================================================================
    // FORCE REDIS FOR EVERYTHING (Sessions + MUC)
    // =============================================================================
    if ($redis_host = getenv('MOODLE_REDIS_HOST')) {
        // 1. Clean the Host string
        if (strpos($redis_host, 'tcp://') === false) {
            $redis_host = 'tcp://' . $redis_host;
        }
        $redis_port = getenv('MOODLE_REDIS_PORT') ?: 6379;

        // -------------------------------------------------------------------------
        // A. SESSION CONFIGURATION
        // -------------------------------------------------------------------------
        $CFG->session_handler_class = '\core\session\redis';
        $CFG->session_redis_host = $redis_host;
        $CFG->session_redis_port = $redis_port;
        $CFG->session_redis_database = 0;
        $CFG->session_redis_prefix = 'moodle_sess_';
        $CFG->session_redis_acquire_lock_timeout = 120;
        $CFG->session_redis_lock_expire = 7200;
        // $CFG->session_redis_auth = ...; // KEEP COMMENTED OUT

        // -------------------------------------------------------------------------
        // B. CACHE (MUC) CONFIGURATION - THE FIX
        // -------------------------------------------------------------------------
        // This overrides whatever broken settings are saved in the Admin UI
        $CFG->muc_config = $CFG->dataroot . '/muc_config.php'; // Pointer file

        $CFG->forced_plugin_settings = [
            'tool_mobile' => [
                'qrcodetype' => 'url',
            ],
            // Force the 'default' Redis store to use our working Env Vars
            'cachestore_redis' => [
                'test_server' => [
                    'server' => $redis_host . ':' . $redis_port,
                    // 'password' => '', // No password
                    'serializer' => 1, // 1 = PHP Serializer (Safest)
                ],
            ],
        ];
    }

    // -------------------------------------------------------------------------
    // 6. System Paths
    // -------------------------------------------------------------------------
    // Explicitly set Ghostscript path (installed in your Dockerfile)
    $CFG->pathtogs = '/usr/bin/gs';

    require_once(__DIR__ . '/lib/setup.php');

    // There is no php closing tag in this file,
    // it is intentional because it prevents trailing whitespace problems!
