apiVersion: apps/v1
kind: Deployment
metadata:
  name: "{{ .Release.Name }}-moodle"
  labels:
    app: moodle
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
spec:
  replicas: {{ .Values.replicaCount }}
  strategy:
    type: {{ .Values.strategy.type }}
    {{- if eq .Values.strategy.type "RollingUpdate" }}
    rollingUpdate:
      maxUnavailable: {{ .Values.strategy.rollingUpdate.maxUnavailable }}
      maxSurge: {{ .Values.strategy.rollingUpdate.maxSurge }}
    {{- end }}
  selector:
    matchLabels:
      app: moodle
      release: {{ .Release.Name }}
  template:
    metadata:
      labels:
        app: moodle
        release: {{ .Release.Name }}
    spec:
      {{- with .Values.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.affinity }}
      affinity:
        {{- toYaml . | nindent 8 }}
      {{- end }}

      {{- with .Values.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      securityContext:
        {{- toYaml .Values.securityContext | nindent 8 }}
      containers:
        - name: moodle
          image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
          imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}
          ports:
            - containerPort: 8080
              name: http

          # --- Liveness/Readiness Probes (Best Practice) ---
          # Prevents K8s from sending traffic before Apache is ready
          livenessProbe:
            httpGet:
              path: /lib/ajax/service.php # Lightweight endpoint
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /lib/ajax/service.php
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5

          # --- Resource Limits (Best Practice) ---
          resources:
            {{- toYaml .Values.resources | nindent 12 }}

          env:
            # 1. Database Connection
            - name: MOODLE_DB_HOST
              value: {{ .Values.externalDatabase.host | quote }}
            - name: MOODLE_DB_PORT
              value: "{{ .Values.externalDatabase.port }}"
            - name: MOODLE_DB_NAME
              value: {{ .Values.externalDatabase.database | quote }}
            - name: MOODLE_DB_USER
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalDatabase.existingSecret.name }}
                  key: {{ .Values.externalDatabase.existingSecret.userKey }}
            - name: MOODLE_DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.externalDatabase.existingSecret.name }}
                  key: {{ .Values.externalDatabase.existingSecret.passwordKey }}

            # 2. Redis Configuration (Conditional)
            # Only injects variables if Redis is enabled in values.yaml
            {{- if .Values.moodle.redis.enabled }}
            - name: MOODLE_REDIS_HOST
              value: {{ .Values.moodle.redis.host | quote }}
            - name: MOODLE_REDIS_PORT
              value: "{{ .Values.moodle.redis.port }}"
            {{- end }}

            # 3. Reverse Proxy & SSL (Critical for Ingress/Keycloak)
            # Checks if Ingress is enabled to automatically turn on Reverse Proxy logic
            {{- if .Values.ingress.enabled }}
            - name: MOODLE_REVERSE_PROXY
              value: "true"
            - name: MOODLE_SSL_PROXY
              value: "true"
            {{- end }}

          volumeMounts:
            - name: moodledata
              mountPath: {{ .Values.persistence.mountPath }}
            - name: config-volume
              mountPath: /var/www/html/config.php
              subPath: config.php

      volumes:
        - name: moodledata
          {{- if .Values.persistence.enabled }}
          persistentVolumeClaim:
            claimName: "{{ .Release.Name }}-moodle-pvc"
          {{- else }}
          emptyDir: {}
          {{- end }}
        - name: config-volume
          configMap:
            name: "{{ .Release.Name }}-moodle-config"
