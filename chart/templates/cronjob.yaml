apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ .Release.Name }}-moodle-cron
  labels:
    app: moodle
    component: cron
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    release: "{{ .Release.Name }}"
spec:
  schedule: "* * * * *" # Moodle requires this to run every minute
  concurrencyPolicy: Forbid # Prevents job pile-up if one run takes > 1 minute
  successfulJobsHistoryLimit: 1 # Keep logs clean
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      backoffLimit: 2
      template:
        metadata:
          labels:
            app: moodle-cron
            component: cron
            release: "{{ .Release.Name }}"
        spec:
          restartPolicy: OnFailure

          # Match the Security Context of your Deployment (User 1001)
          securityContext:
            runAsUser: 1001
            runAsGroup: 1001
            fsGroup: 1001

          containers:
            - name: moodle-cron
              image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
              imagePullPolicy: {{ .Values.image.pullPolicy | default "IfNotPresent" }}

              # The Command: Runs the Moodle CLI cron script
              command: ["/usr/local/bin/php", "/var/www/html/admin/cli/cron.php"]

              # 1. Environment Variables
              # These MUST match your Deployment exactly so config.php works
              env:
                - name: MOODLE_DB_HOST
                  value: {{ .Values.externalDatabase.host }}
                - name: MOODLE_DB_PORT
                  value: "{{ .Values.externalDatabase.port }}"
                - name: MOODLE_DB_NAME
                  value: {{ .Values.externalDatabase.database }}
                - name: MOODLE_DB_USER
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalDatabase.existingSecret.name }}
                      key: {{ .Values.externalDatabase.existingSecret.userKey }}
                - name: MOODLE_DB_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: {{ .Values.externalDatabase.existingSecret.name }}
                      key: {{ .Values.externalDatabase.existingSecret.passwordKey }}

                {{- if .Values.moodle.redis.enabled }}
                - name: MOODLE_REDIS_HOST
                  value: {{ .Values.moodle.redis.host | quote }}
                - name: MOODLE_REDIS_PORT
                  value: "{{ .Values.moodle.redis.port }}"
                {{- end }}

                {{- if .Values.ingress.enabled }}
                - name: MOODLE_SSL_PROXY
                  value: {{ .Values.moodle.proxy.sslProxy | quote }}

                - name: MOODLE_REVERSE_PROXY
                  value: {{ .Values.moodle.proxy.reverseProxy | quote }}
                {{- end }}

              # 2. Volume Mounts
              volumeMounts:
                - name: moodledata
                  mountPath: /var/www/moodledata
                - name: config-volume
                  mountPath: /var/www/html/config.php
                  subPath: config.php

          # 3. Volumes
          volumes:
            - name: moodledata
              persistentVolumeClaim:
                claimName: {{ .Release.Name }}-moodle-pvc
            - name: config-volume
              configMap:
                name: {{ .Release.Name }}-moodle-config
